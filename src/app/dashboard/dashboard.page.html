<ion-content class="uber-dashboard" [fullscreen]="true">
  <app-loader
    *ngIf="isLoading"
    [text]="'Preparing your library'"
    subtext="Loading your reading journey..."
  ></app-loader>

  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingIcon="sparkles-outline"
      refreshingSpinner="crescent"
      pullingText="Pull down to refresh your library âœ¨"
      refreshingText="Refreshing content..."
    ></ion-refresher-content>
  </ion-refresher>

  <!-- Uber Header -->
  <div class="uber-header">
    <div class="header-left">
      <div class="uber-logo">
        <div class="line-logo">
          <div class="line-segment"></div>
          <div class="line-segment"></div>
          <div class="line-segment"></div>
        </div>
      </div>
      <h1 class="app-name">Book<span>Library</span></h1>
    </div>
  </div>

  <!-- Uber Search Section -->
  <div class="uber-search">
    <div class="search-input-container">
      <ion-searchbar
        [(ngModel)]="searchQuery"
        (ionChange)="onSearch($event)"
        placeholder="Search books, authors, genres..."
        [debounce]="300"
        [showClearButton]="'always'"
        (ionClear)="clearSearch()"
        class="search-bar"
        [searchIcon]="null"
      ></ion-searchbar>
      <button
        class="filter-btn"
        (click)="openFilters()"
        title="Filter and sort"
      >
        <ion-icon name="filter-outline"></ion-icon>
      </button>
    </div>
  </div>

  <!-- Search Results -->
  <div
    class="search-results"
    *ngIf="showSearchResults && filteredBooks.length > 0"
  >
    <div class="section-title">Search Results</div>
    <div
      class="result-item"
      *ngFor="let book of filteredBooks"
      (click)="openBook(book)"
    >
      <ng-container *ngIf="book.image; else placeholderImage">
        <img
          [src]="book.image"
          (error)="book.image = ''"
          alt="{{ book.title }}"
          loading="lazy"
          class="result-image"
        />
      </ng-container>
      <ng-template #placeholderImage>
        <div
          class="result-image placeholder-cover"
          [ngClass]="getGradientClass(book.title)"
        >
          <span>{{ getInitials(book.title) }}</span>
        </div>
      </ng-template>
      <div class="result-info">
        <h4>{{book.title}}</h4>
        <p>{{book.author}}</p>
      </div>
      <ion-icon name="chevron-forward-outline" class="result-arrow"></ion-icon>
    </div>
  </div>

  <div
    class="no-results"
    *ngIf="showSearchResults && filteredBooks.length === 0"
  >
    <div class="no-results-content">
      <ion-icon name="search-outline"></ion-icon>
      <p>No books found for "{{searchQuery}}"</p>
    </div>
  </div>

  <!-- Quick Stats Section -->
  <div class="suggestions-section">
    <div class="section-header">
      <div class="section-title">Your Library Stats</div>
    </div>
    <div class="suggestions-grid">
      <div class="suggestion-card promo">
        <div class="suggestion-icon">
          <ion-icon name="library-outline"></ion-icon>
        </div>
        <div class="suggestion-label">
          {{ (allBooks ?? [])?.length || 0 }} Books
        </div>
      </div>
      <div
        class="suggestion-card"
        *ngIf="continueReading"
        (click)="navigateToReadBook(continueReading.bookId.toString())"
      >
        <div class="suggestion-icon">
          <ion-icon name="play-outline"></ion-icon>
        </div>
        <div class="suggestion-label">Continue</div>
      </div>
      <div class="suggestion-card" (click)="seeAllBooks()">
        <div class="suggestion-icon">
          <ion-icon name="grid-outline"></ion-icon>
        </div>
        <div class="suggestion-label">All Books</div>
      </div>
      <div class="suggestion-card">
        <div class="suggestion-icon">
          <ion-icon name="trophy-outline"></ion-icon>
        </div>
        <div class="suggestion-label">5 Done</div>
      </div>
    </div>
  </div>

  <!-- Top 10 Books by Language Section -->
  <div class="top-books-by-language" *ngIf="topBooksByLanguage.length > 0">
    <div *ngFor="let group of topBooksByLanguage">
      <div class="section-header">
        <div class="section-title">Top 10 {{ group.language }} Books</div>
        <button class="see-all-btn" (click)="seeAllBooks(group.language)">
          <span>See all</span>
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </button>
      </div>

      <div class="books-horizontal-scroll">
        <div
          class="book-card"
          *ngFor="let book of group.books"
          (click)="navigateToBook(book.id.toString())"
        >
          <div class="book-cover">
            <ng-container *ngIf="book.image; else placeholderBook">
              <img
                [src]="book.image"
                (error)="book.image = ''"
                alt="{{ book.title }}"
                loading="lazy"
              />
            </ng-container>
            <ng-template #placeholderBook>
              <div
                class="placeholder-book"
                [ngClass]="getGradientForBook(book.title)"
              >
                <div class="book-content">
                  <div class="book-initials">{{ getInitials(book.title) }}</div>
                </div>
              </div>
            </ng-template>

            <div class="rating-badge" *ngIf="book.rating">
              <ion-icon name="star"></ion-icon>
              <span>{{ book.rating }}</span>
            </div>
          </div>
          <div class="book-info">
            <h4 class="book-title">{{ book.title }}</h4>
            <p class="book-author">{{ book.author }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Continue Reading Section -->
  <div class="main-content-section" *ngIf="continueReading">
    <div class="section-title">Continue Reading</div>
    <div class="content-cards">
      <div
        class="content-card"
        (click)="navigateToReadBook(continueReading.bookId.toString(), continueReading.currentPage)"
      >
        <div class="card-content">
          <div class="card-title">{{ continueReading.book.title }}</div>
          <div class="card-subtitle">
            {{ continueReading.percentage }}% complete
          </div>
        </div>
        <div class="card-image">
          <ion-icon name="book-outline"></ion-icon>
        </div>
      </div>
    </div>
  </div>

  <!-- Genres Section (Uber Style Grid) -->
  <div class="genres-section" *ngIf="genres && genres.length > 0">
    <div class="section-title">Explore Genres</div>
    <div class="uber-services-grid">
      <div
        class="genre-card"
        *ngFor="let genre of genres.slice(0, 6); let i = index"
        (click)="navigateToGenre(genre.name)"
      >
        <div class="genre-icon">
          <ion-icon [name]="getGenreIcon(genre.name)"></ion-icon>
        </div>
        <div class="genre-label">{{ genre.name }}</div>
      </div>
    </div>
  </div>

  <!-- Popular Books by Rating (Horizontal Scroll) -->
  <div
    class="popular-books-section"
    *ngIf="popularBooks && popularBooks.length > 0"
  >
    <div class="section-header">
      <div class="section-title">Popular Books by Rating</div>
      <button class="see-all-btn" (click)="seeAllBooks()">
        <span>See all</span>
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </button>
    </div>
    <div class="books-horizontal-scroll">
      <div
        class="book-card"
        *ngFor="let book of popularBooks?.slice(0, 8) || []"
        (click)="navigateToBook(book?.id?.toString())"
      >
        <div class="book-cover">
          <ng-container *ngIf="book?.image; else placeholderBook">
            <img
              [src]="book.image"
              (error)="book.image = ''"
              alt="{{ book.title }}"
              loading="lazy"
            />
          </ng-container>
          <ng-template #placeholderBook>
            <div
              class="placeholder-book"
              [ngClass]="getGradientForBook(book.title)"
            >
              <div class="book-content">
                <div class="book-initials">
                  {{ getInitials(book?.title || '') }}
                </div>
                <div class="book-title-overlay">
                  {{ book?.title || 'Untitled' }}
                </div>
              </div>
            </div>
          </ng-template>
          <div class="rating-badge" *ngIf="book.rating">
            <ion-icon name="star"></ion-icon>
            <span>{{ book.rating }}</span>
          </div>
        </div>
        <div class="book-info">
          <h4 class="book-title">{{ book.title }}</h4>
          <p class="book-author">{{ book.author }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Plan Your Next Read Section -->
  <div class="plan-section" *ngIf="recentBooks && recentBooks.length > 0">
    <div class="section-title">Plan your next read</div>
    <div class="plan-cards">
      <div
        class="plan-card small"
        *ngIf="recentBooks[0]"
        (click)="navigateToBook(recentBooks[0].id.toString())"
      >
        <div class="plan-content">
          <div class="plan-text">
            <h3>{{ recentBooks[0].title }}</h3>
            <p>by {{ recentBooks[0].author }}</p>
          </div>
          <div class="plan-image">
            <img
              (error)="recentBooks[0].image = ''"
              *ngIf="recentBooks[0].image"
              [src]="recentBooks[0].image"
              [alt]="recentBooks[0].title"
              loading="lazy"
            />
            <div
              *ngIf="!recentBooks[0].image"
              class="placeholder-plan"
              [ngClass]="getGradientForBook(recentBooks[0].title)"
            >
              <div class="plan-content">
                <ion-icon name="book-outline"></ion-icon>
                <div class="plan-title-overlay">
                  {{ recentBooks[0].title || 'Continue Reading' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        class="plan-card small"
        *ngIf="recentBooks[1]"
        (click)="navigateToBook(recentBooks[1].id.toString())"
      >
        <div class="plan-content">
          <div class="plan-text">
            <h4>{{ recentBooks[1].title }}</h4>
            <p>{{ recentBooks[1].author }}</p>
          </div>
          <div class="plan-image-small">
            <img
              *ngIf="recentBooks[1].image"
              [src]="recentBooks[1].image"
              [alt]="recentBooks[1].title"
              loading="lazy"
            />
            <div
              *ngIf="!recentBooks[1].image"
              class="placeholder-plan-small"
              [ngClass]="getGradientForBook(recentBooks[1].title)"
            >
              <div class="plan-content">
                <ion-icon name="book-outline"></ion-icon>
                <div class="plan-title-overlay">
                  {{ recentBooks[1].title || 'Next Read' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Add bottom spacing to prevent hiding behind tabs -->
    <div class="bottom-spacer"></div>
  </div>
</ion-content>

<!-- Notifications Dropdown -->
<div
  class="notifications-dropdown"
  *ngIf="showNotifications"
  (click)="toggleNotifications()"
>
  <div class="notifications-content" (click)="$event.stopPropagation()">
    <div class="notifications-header">
      <h3>Notifications</h3>
      <button class="close-btn" (click)="toggleNotifications()">
        <ion-icon name="close-outline"></ion-icon>
      </button>
    </div>
    <div class="notifications-list">
      <div
        class="notification-item"
        *ngFor="let notification of notifications"
        [class.unread]="!notification.read"
        (click)="markNotificationAsRead(notification.id)"
      >
        <div class="notification-content">
          <h4>{{notification.title}}</h4>
          <p>{{notification.message}}</p>
          <span class="notification-time">{{notification.time}}</span>
        </div>
        <div class="notification-indicator" *ngIf="!notification.read"></div>
      </div>
    </div>
  </div>
</div>

<!-- Filter Modal -->
<div class="filter-modal" *ngIf="showFilters" (click)="closeFilters()">
  <div class="filter-content" (click)="$event.stopPropagation()">
    <div class="filter-header">
      <h3>Filter & Sort</h3>
      <button class="close-btn" (click)="closeFilters()">
        <ion-icon name="close-outline"></ion-icon>
      </button>
    </div>

    <div class="filter-body">
      <!-- Sort Options -->
      <div class="filter-section">
        <h4>Sort By</h4>
        <div class="sort-options">
          <button
            class="sort-option"
            [class.active]="sortBy === 'title'"
            (click)="setSortBy('title')"
          >
            <ion-icon name="text-outline"></ion-icon>
            <span>Title</span>
          </button>
          <button
            class="sort-option"
            [class.active]="sortBy === 'author'"
            (click)="setSortBy('author')"
          >
            <ion-icon name="person-outline"></ion-icon>
            <span>Author</span>
          </button>
          <button
            class="sort-option"
            [class.active]="sortBy === 'rating'"
            (click)="setSortBy('rating')"
          >
            <ion-icon name="star-outline"></ion-icon>
            <span>Rating</span>
          </button>
          <button
            class="sort-option"
            [class.active]="sortBy === 'recent'"
            (click)="setSortBy('recent')"
          >
            <ion-icon name="time-outline"></ion-icon>
            <span>Recent</span>
          </button>
        </div>
      </div>

      <!-- Genre Filters -->
      <div class="filter-section">
        <h4>Genres</h4>
        <div class="genre-filters">
          <button
            *ngFor="let genre of genres"
            class="genre-chip"
            [class.selected]="selectedGenres.includes(genre.name)"
            (click)="toggleGenreFilter(genre.name)"
          >
            {{genre.name}}
          </button>
        </div>
      </div>
    </div>

    <div class="filter-footer">
      <button class="clear-btn" (click)="clearFilters()">
        <ion-icon name="refresh-outline"></ion-icon>
        <span>Clear All</span>
      </button>
      <button class="apply-btn" (click)="closeFilters()">
        <ion-icon name="checkmark-outline"></ion-icon>
        <span>Apply</span>
      </button>
    </div>
  </div>
</div>
